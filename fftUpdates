import numpy as np
import matplotlib.pyplot as plt

from bokeh.io import push_notebook, show, output_notebook
from bokeh.layouts import row
from bokeh.plotting import figure
from bokeh.palettes import BuPu, Greens, Set3, Blues, Oranges

#Uses numpy version of FFT! Not scikit

output_notebook()
opts = dict(plot_width=600, plot_height=400, min_border=0)

#Create some data
# Number of sample points
N = 2048
CHUNK = N
# sample spacing
T = 1.0 / 1024.0
RATE = 1024
x = np.linspace(0.0, N*T, N)
data = np.sin(50.0 * 2.0*np.pi*x) + 0.5*np.sin(80.0 * 2.0*np.pi*x)

#Open file
fileName = 'w_m_combined.data'

f = open(fileName,'r')
dataRaw = np.loadtxt(f, delimiter=' ')
f.close()

#Create plot
p2 = figure(**opts)

for i in range(len(dataRaw)):
        
    #Get data
    data = np.frombuffer(dataRaw[i])[:2048]

    #Smooth the FFT by windowing data
    data = data * np.hanning(len(data))
    
    #Preform FFT and take only real data
    fft = abs(np.fft.fft(data).real)
    
    #Keep only first half
    fft = fft[:int(len(fft))/2]
    
    #Create Frequency list
    freq = np.fft.fftfreq(CHUNK,1.0/RATE)
    
    #Keep only first half
    freq = freq[:int(len(freq))/2] 

    #At this point, the length of the fft/freq is cut in reduced from 2048 to 1024. But the cut off frequency is actually 512.
    #The freq axis shows why. Values are now 0, 0.5, 1, 1.5Hz...
    #Therefore drop every other value
    fft = fft[0::2]
    freq = freq[0::2]

    #Trim off what isn't needed
    maxList = np.sort(fft[100:-100])
    
    #Find peak
    freqPeak = np.where(fft==maxList[-1])[0]
    print("peak frequency: %d Hz"%freqPeak)
    
    
    #For plotting patches, we must close the polygon
    fft = np.append(fft, [fft[-1], 0] )
    freq = np.append(freq, [len(freq)+1, 10])
    
    legendName = 'Data' + str(i)

    #Plot
    if i < 5:
        p2.patches([freq], [fft], line_width=1, color=Oranges[9][i], alpha=0.1, legend=legendName)
    else:
        p2.patches([freq], [fft], line_width=1, color=Blues[9][i-5], alpha=0.1, legend=legendName)

        
p2.legend.location = 'top_right'
p2.legend.click_policy = 'hide'
show(p2)
